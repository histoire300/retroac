<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©troaction sur mes r√©ponses en histoire</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- 
    CONFIGURATION GOOGLE SHEETS - √âTAPES IMPORTANTES :
    
    1. Votre Google Sheets doit avoir ces onglets :
       - "Eleves" avec colonnes : nom | classe | motDePasse
       - "Evaluations" avec colonnes : nom | type | questions | date  
       - "Donnees" avec colonnes : nom | classe | evaluation | date | qualite_vsc | qualite_hors_sujet | qualite_faux | qualite_incomplet | ensuite_analyse | ensuite_lecture | ensuite_redaction | ensuite_memoire
    
    2. Partage : "Tous les utilisateurs ayant le lien" en mode "√âditeur"
    
    3. ID configur√© : 1koJCO9Mpr1ORy4lVX_4eaXkuVP1vEgQmaCor-_Is0WI
    
    4. Pour l'√©criture compl√®te, cr√©ez un Google Apps Script Web App (instructions dans le JavaScript ci-dessous)
    -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, rgba(7,45,110,0.1) 0%, rgba(208,13,43,0.1) 100%);
            min-height: 100vh;
            color: rgba(7,45,110,1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-top: 5px solid rgba(7,45,110,1);
        }

        .header h1 {
            color: rgba(7,45,110,1);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: rgba(208,13,43,1);
            font-size: 1.2em;
            font-weight: bold;
        }

        .main-buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .btn {
            background: rgba(7,45,110,1);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            min-width: 200px;
        }

        .btn:hover {
            background: rgba(208,13,43,1);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: rgba(208,13,43,1);
        }

        .btn-secondary:hover {
            background: rgba(7,45,110,1);
        }

        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            border-left: 5px solid rgba(7,45,110,1);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: rgba(7,45,110,1);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: rgba(7,45,110,1);
        }

        .feedback-grid {
            margin-top: 30px;
        }

        .feedback-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid rgba(208,13,43,1);
        }

        .feedback-section h3 {
            color: rgba(7,45,110,1);
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .feedback-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            align-items: center;
            margin-bottom: 10px;
        }

        .feedback-row label {
            margin-bottom: 0 !important;
        }

        .feedback-row input {
            width: 80px !important;
            text-align: center;
        }

        .message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .message.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .hidden {
            display: none;
        }

        .password-form {
            max-width: 400px;
            margin: 0 auto;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .chart-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            text-align: center;
            color: rgba(7,45,110,1);
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .main-buttons {
                flex-direction: column;
                align-items: center;
            }

            .charts-container {
                grid-template-columns: 1fr;
            }

            .feedback-row {
                grid-template-columns: 1fr;
                gap: 5px;
            }
        }

        .back-btn {
            background: #6c757d;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: rgba(7,45,110,1);
        }

        .teacher-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .teacher-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .evaluation-setup {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid rgba(7,45,110,1);
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .student-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .student-card:hover {
            background: rgba(7,45,110,0.1);
            border-color: rgba(7,45,110,1);
        }

        .class-selector {
            margin-bottom: 20px;
        }

        .class-selector button {
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .class-selector button.active {
            background: rgba(208,13,43,1);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Page d'accueil -->
        <div id="home-page">
            <div class="header">
                <h1>R√©troaction sur mes r√©ponses en histoire</h1>
                <p>Secondaire 3 - Histoire du Qu√©bec</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid rgba(208,13,43,1);">
                    <strong>üìù Format du mot de passe :</strong><br>
                    <span style="color: rgba(7,45,110,1);">Nom de famille + Premi√®re lettre du pr√©nom</span><br>
                    <em style="color: #6c757d; font-size: 0.9em;">Exemple : Lemire Alain = LemireA</em>
                </div>
            </div>
            
            <div class="main-buttons">
                <button class="btn" onclick="showStudentLogin()">Entr√©e de mes donn√©es</button>
                <button class="btn btn-secondary" onclick="showStudentGraphs()">Voir mes graphiques</button>
                <button class="btn" onclick="showTeacherLogin()">Enseignant</button>
            </div>
        </div>

        <!-- Connexion √©l√®ve -->
        <div id="student-login" class="hidden">
            <button class="btn back-btn" onclick="showHome()">‚Üê Retour</button>
            <div class="card">
                <h2>Connexion √©l√®ve</h2>
                <div class="password-form">
                    <div class="form-group">
                        <label for="student-password">Mot de passe :</label>
                        <input type="password" id="student-password" placeholder="*VOTREMOTDEPASSE">
                    </div>
                    <button class="btn" onclick="loginStudent()">Se connecter</button>
                    <div id="student-login-message"></div>
                </div>
            </div>
        </div>

        <!-- Connexion enseignant -->
        <div id="teacher-login" class="hidden">
            <button class="btn back-btn" onclick="showHome()">‚Üê Retour</button>
            <div class="card">
                <h2>Connexion enseignant</h2>
                <div class="password-form">
                    <div class="form-group">
                        <label for="teacher-password">Mot de passe :</label>
                        <input type="password" id="teacher-password">
                    </div>
                    <button class="btn" onclick="loginTeacher()">Se connecter</button>
                    <div id="teacher-login-message"></div>
                </div>
            </div>
        </div>

        <!-- Formulaire de donn√©es √©l√®ve -->
        <div id="student-form" class="hidden">
            <button class="btn back-btn" onclick="showHome()">‚Üê Retour</button>
            <div class="card">
                <h2>R√©troaction sur mes r√©ponses en histoire</h2>
                <div id="form-message"></div>
                
                <div class="form-group">
                    <label>Ton nom :</label>
                    <input type="text" id="student-name" readonly>
                </div>
                
                <div class="form-group">
                    <label>Ta classe :</label>
                    <input type="text" id="student-class" readonly>
                </div>
                
                <div class="form-group">
                    <label for="evaluation-select">Nom de l'√©valuation :</label>
                    <select id="evaluation-select">
                        <option value="">S√©lectionner une √©valuation</option>
                    </select>
                </div>

                <div class="feedback-grid">
                    <div class="feedback-section">
                        <h3>Qualit√© de tes r√©ponses</h3>
                        <div class="feedback-row">
                            <label>VSC :</label>
                            <input type="number" id="qualite-vsc" min="0" value="0">
                        </div>
                        <div class="feedback-row">
                            <label>Hors sujet :</label>
                            <input type="number" id="qualite-hors-sujet" min="0" value="0">
                        </div>
                        <div class="feedback-row">
                            <label>Faux :</label>
                            <input type="number" id="qualite-faux" min="0" value="0">
                        </div>
                        <div class="feedback-row">
                            <label>Incomplet :</label>
                            <input type="number" id="qualite-incomplet" min="0" value="0">
                        </div>
                    </div>

                    <div class="feedback-section">
                        <h3>Que faire ensuite</h3>
                        <div class="feedback-row">
                            <label>Analyse mieux la question :</label>
                            <input type="number" id="ensuite-analyse" min="0" value="0">
                        </div>
                        <div class="feedback-row">
                            <label>Fais mieux ta lecture strat√©gique :</label>
                            <input type="number" id="ensuite-lecture" min="0" value="0">
                        </div>
                        <div class="feedback-row">
                            <label>R√©dige mieux ta r√©ponse :</label>
                            <input type="number" id="ensuite-redaction" min="0" value="0">
                        </div>
                        <div class="feedback-row" id="memoire-row">
                            <label>R√©cup√®re mieux en m√©moire avant l'examen :</label>
                            <input type="number" id="ensuite-memoire" min="0" value="0">
                        </div>
                    </div>
                </div>

                <button class="btn" onclick="saveStudentData()">Enregistrer mes donn√©es</button>
            </div>
        </div>

        <!-- Graphiques √©l√®ve -->
        <div id="student-graphs" class="hidden">
            <button class="btn back-btn" onclick="showHome()">‚Üê Retour</button>
            <div class="card">
                <h2>R√©troaction sur mes r√©ponses en histoire</h2>
                <div class="password-form">
                    <div class="form-group">
                        <label for="graphs-password">Mot de passe :</label>
                        <input type="password" id="graphs-password" placeholder="*VOTREMOTDEPASSE">
                    </div>
                    <button class="btn" onclick="showStudentGraphsData()">Voir mes graphiques</button>
                    <div id="graphs-login-message"></div>
                </div>
            </div>
            
            <div id="student-charts" class="hidden">
                <div class="card">
                    <h3 id="student-charts-title">Mes graphiques</h3>
                    <div id="evaluation-charts"></div>
                    <div id="summary-charts" class="charts-container">
                        <div class="chart-card">
                            <h3>Qualit√© de tes r√©ponses - Toutes √©valuations</h3>
                            <canvas id="summary-quality-chart"></canvas>
                        </div>
                        <div class="chart-card">
                            <h3>Que faire ensuite - Toutes √©valuations</h3>
                            <canvas id="summary-next-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interface enseignant -->
        <div id="teacher-panel" class="hidden">
            <button class="btn back-btn" onclick="showHome()">‚Üê Retour</button>
            <div class="teacher-panel">
                <h2>Interface Enseignant</h2>
                
                <div class="teacher-controls">
                    <div class="evaluation-setup">
                        <h3>Cr√©er une nouvelle √©valuation</h3>
                        <div class="form-group">
                            <label for="new-eval-name">Nom de l'√©valuation :</label>
                            <input type="text" id="new-eval-name" placeholder="Ex: C1-√âvaluation 1">
                        </div>
                        <div class="form-group">
                            <label for="eval-type">Type d'√©valuation :</label>
                            <select id="eval-type">
                                <option value="C1">C1 (D√©crire)</option>
                                <option value="C2">C2 (Expliquer)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="question-count">Nombre de questions :</label>
                            <input type="number" id="question-count" min="1" max="20" value="15">
                        </div>
                        <button class="btn" onclick="createEvaluation()">Cr√©er l'√©valuation</button>
                    </div>
                </div>

                <div class="card">
                    <h3>Visualisation des donn√©es</h3>
                    <div class="class-selector">
                        <button class="btn" onclick="showClassData('all')">Tous les √©l√®ves</button>
                        <button class="btn" onclick="showClassData('301')">Classe 301</button>
                        <button class="btn" onclick="showClassData('302')">Classe 302</button>
                        <button class="btn" onclick="showClassData('303')">Classe 303</button>
                    </div>
                    <div id="teacher-charts"></div>
                </div>

                <div class="card">
                    <h3>Donn√©es individuelles</h3>
                    <div id="students-list" class="students-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Google Sheets
        const SHEET_ID = '1koJCO9Mpr1ORy4lVX_4eaXkuVP1vEgQmaCor-_Is0WI';
        const SHEETS_BASE_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?`;
        
        // Donn√©es des √©l√®ves (nouvelles donn√©es d'identification)
        const studentsData = [
            {nom: "AudetK", classe: 301, motDePasse: "AudetK"},
            {nom: "Barri√®reA", classe: 301, motDePasse: "Barri√®reA"},
            {nom: "BilodeauL", classe: 301, motDePasse: "BilodeauL"},
            {nom: "BolducH", classe: 301, motDePasse: "BolducH"},
            {nom: "ChouinardL", classe: 301, motDePasse: "ChouinardL"},
            {nom: "Croteau√â", classe: 301, motDePasse: "Croteau√â"},
            {nom: "Cusson√â", classe: 301, motDePasse: "Cusson√â"},
            {nom: "DelisleD", classe: 301, motDePasse: "DelisleD"},
            {nom: "DrouinC", classe: 301, motDePasse: "DrouinC"},
            {nom: "DuchesneauJ", classe: 301, motDePasse: "DuchesneauJ"},
            {nom: "DuplessisC", classe: 301, motDePasse: "DuplessisC"},
            {nom: "Faucher-PattersonH", classe: 301, motDePasse: "Faucher-PattersonH"},
            {nom: "FontaineC", classe: 301, motDePasse: "FontaineC"},
            {nom: "Gagnon-RivardM", classe: 301, motDePasse: "Gagnon-RivardM"},
            {nom: "GrenierL", classe: 301, motDePasse: "GrenierL"},
            {nom: "Grondin√â", classe: 301, motDePasse: "Grondin√â"},
            {nom: "LamoureuxS", classe: 301, motDePasse: "LamoureuxS"},
            {nom: "L√©veill√©eM", classe: 301, motDePasse: "L√©veill√©eM"},
            {nom: "MorinM", classe: 301, motDePasse: "MorinM"},
            {nom: "RicherT", classe: 301, motDePasse: "RicherT"},
            {nom: "SantosF", classe: 301, motDePasse: "SantosF"},
            {nom: "VennerM", classe: 301, motDePasse: "VennerM"},
            {nom: "VigneuxP", classe: 301, motDePasse: "VigneuxP"},
            {nom: "VincentL", classe: 301, motDePasse: "VincentL"},
            {nom: "AudyC", classe: 302, motDePasse: "AudyC"},
            {nom: "Beaus√©jourM", classe: 302, motDePasse: "Beaus√©jourM"},
            {nom: "B√©lisleF", classe: 302, motDePasse: "B√©lisleF"},
            {nom: "B√©lisleX", classe: 302, motDePasse: "B√©lisleX"},
            {nom: "BlanchetteG", classe: 302, motDePasse: "BlanchetteG"},
            {nom: "BoulangerD", classe: 302, motDePasse: "BoulangerD"},
            {nom: "CampeauA", classe: 302, motDePasse: "CampeauA"},
            {nom: "CastonguayM", classe: 302, motDePasse: "CastonguayM"},
            {nom: "CoutureO", classe: 302, motDePasse: "CoutureO"},
            {nom: "FontaineM", classe: 302, motDePasse: "FontaineM"},
            {nom: "GamacheK", classe: 302, motDePasse: "GamacheK"},
            {nom: "GrondinC", classe: 302, motDePasse: "GrondinC"},
            {nom: "GuimontZ", classe: 302, motDePasse: "GuimontZ"},
            {nom: "Lacasse√â", classe: 302, motDePasse: "Lacasse√â"},
            {nom: "LaflammeZ", classe: 302, motDePasse: "LaflammeZ"},
            {nom: "Lemieux√à", classe: 302, motDePasse: "Lemieux√à"},
            {nom: "MalenfantW", classe: 302, motDePasse: "MalenfantW"},
            {nom: "McVeighK", classe: 302, motDePasse: "McVeighK"},
            {nom: "M√©nardT", classe: 302, motDePasse: "M√©nardT"},
            {nom: "NadeauA", classe: 302, motDePasse: "NadeauA"},
            {nom: "Nadeau√â", classe: 302, motDePasse: "Nadeau√â"},
            {nom: "NadeauF", classe: 302, motDePasse: "NadeauF"},
            {nom: "NaultO", classe: 302, motDePasse: "NaultO"},
            {nom: "PaquetteJ", classe: 302, motDePasse: "PaquetteJ"},
            {nom: "PednaultW", classe: 302, motDePasse: "PednaultW"},
            {nom: "RaymondA", classe: 302, motDePasse: "RaymondA"},
            {nom: "RoyO", classe: 302, motDePasse: "RoyO"},
            {nom: "SimardW", classe: 302, motDePasse: "SimardW"},
            {nom: "SpoonerR", classe: 302, motDePasse: "SpoonerR"},
            {nom: "TarantoJ", classe: 302, motDePasse: "TarantoJ"},
            {nom: "AlvarezK", classe: 303, motDePasse: "AlvarezK"},
            {nom: "BeaudoinT", classe: 303, motDePasse: "BeaudoinT"},
            {nom: "BellemareL", classe: 303, motDePasse: "BellemareL"},
            {nom: "BelleroseL", classe: 303, motDePasse: "BelleroseL"},
            {nom: "BergeronM", classe: 303, motDePasse: "BergeronM"},
            {nom: "BouxC", classe: 303, motDePasse: "BouxC"},
            {nom: "Brochu-CaronM", classe: 303, motDePasse: "Brochu-CaronM"},
            {nom: "CloutierM", classe: 303, motDePasse: "CloutierM"},
            {nom: "CourchesneC", classe: 303, motDePasse: "CourchesneC"},
            {nom: "D'Aragon-Gagn√©A", classe: 303, motDePasse: "D'Aragon-Gagn√©A"},
            {nom: "DionC", classe: 303, motDePasse: "DionC"},
            {nom: "DionM", classe: 303, motDePasse: "DionM"},
            {nom: "DufourJ", classe: 303, motDePasse: "DufourJ"},
            {nom: "FecteauV", classe: 303, motDePasse: "FecteauV"},
            {nom: "FigueroaM", classe: 303, motDePasse: "FigueroaM"},
            {nom: "FournierK", classe: 303, motDePasse: "FournierK"},
            {nom: "Gagn√©√â", classe: 303, motDePasse: "Gagn√©√â"},
            {nom: "Gagnon√â", classe: 303, motDePasse: "Gagnon√â"},
            {nom: "GosselinA", classe: 303, motDePasse: "GosselinA"},
            {nom: "GrenierM", classe: 303, motDePasse: "GrenierM"},
            {nom: "HouldB", classe: 303, motDePasse: "HouldB"},
            {nom: "LaporteC", classe: 303, motDePasse: "LaporteC"},
            {nom: "MorinL", classe: 303, motDePasse: "MorinL"},
            {nom: "ParadisC", classe: 303, motDePasse: "ParadisC"},
            {nom: "P√©pinL", classe: 303, motDePasse: "P√©pinL"},
            {nom: "PerreaultR", classe: 303, motDePasse: "PerreaultR"},
            {nom: "QuinlanB", classe: 303, motDePasse: "QuinlanB"},
            {nom: "Roy-LefebvreT", classe: 303, motDePasse: "Roy-LefebvreT"},
            {nom: "TambaK", classe: 303, motDePasse: "TambaK"},
            {nom: "TherrianA", classe: 303, motDePasse: "TherrianA"},
            {nom: "ThibodeauU", classe: 303, motDePasse: "ThibodeauU"},
            {nom: "TrottierT", classe: 303, motDePasse: "TrottierT"},
            {nom: "TurcotteC", classe: 303, motDePasse: "TurcotteC"},
            {nom: "VeilleuxJ", classe: 303, motDePasse: "VeilleuxJ"}
        ];

        // Variables globales
        let currentStudent = null;
        let evaluations = [];
        let studentData = [];
        
        // Fonctions Google Sheets
        async function readFromSheet(sheetName, range = '') {
            try {
                const query = range ? `SELECT * WHERE A IS NOT NULL` : `SELECT *`;
                const url = `${SHEETS_BASE_URL}sheet=${sheetName}&tq=${encodeURIComponent(query)}&tqx=out:json`;
                
                const response = await fetch(url);
                const text = await response.text();
                
                // Parse de la r√©ponse Google Visualization API
                const json = JSON.parse(text.substring(47).slice(0, -2));
                
                if (json.table && json.table.rows) {
                    return json.table.rows.map(row => 
                        row.c.map(cell => cell ? cell.v : '')
                    );
                }
                return [];
            } catch (error) {
                console.error('Erreur lecture Google Sheets:', error);
                return [];
            }
        }
        
        async function writeToSheet(data) {
            try {
                // IMPORTANT: Pour que l'√©criture fonctionne, vous devez cr√©er un Google Apps Script Web App
                // Instructions compl√®tes ci-dessous dans les commentaires
                
                // Pour l'instant, utilisation du fallback localStorage
                // Une fois le Google Apps Script configur√©, remplacez l'URL ci-dessous
                const WEBAPP_URL = `https://script.google.com/macros/s/YOUR_WEBAPP_ID/exec`; // √Ä configurer
                
                /*
                // Code √† utiliser une fois le Web App configur√© :
                const response = await fetch(WEBAPP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                return response.ok;
                */
                
                // Fallback temporaire vers localStorage
                return saveToLocalStorage(data);
            } catch (error) {
                console.error('Erreur √©criture Google Sheets:', error);
                return saveToLocalStorage(data);
            }
        }
        
        function saveToLocalStorage(data) {
            try {
                if (data.type === 'student_data') {
                    let allData = JSON.parse(localStorage.getItem('studentData') || '[]');
                    allData = allData.filter(d => !(d.nom === data.nom && d.evaluation === data.evaluation));
                    allData.push(data);
                    localStorage.setItem('studentData', JSON.stringify(allData));
                } else if (data.type === 'evaluation') {
                    let evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
                    evaluations.push(data);
                    localStorage.setItem('evaluations', JSON.stringify(evaluations));
                }
                return true;
            } catch (error) {
                console.error('Erreur localStorage:', error);
                return false;
            }
        }
        
        async function loadEvaluationsFromSheet() {
            try {
                const data = await readFromSheet('Evaluations');
                if (data.length > 1) { // Skip header row
                    evaluations = data.slice(1).map(row => ({
                        name: row[0],
                        type: row[1], 
                        questions: parseInt(row[2]),
                        date: row[3]
                    })).filter(eval => eval.name); // Filter out empty rows
                } else {
                    // Fallback to localStorage
                    evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
                }
            } catch (error) {
                console.error('Erreur chargement √©valuations:', error);
                evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
            }
        }
        
        async function loadStudentDataFromSheet() {
            try {
                const data = await readFromSheet('Donnees');
                if (data.length > 1) { // Skip header row
                    studentData = data.slice(1).map(row => ({
                        nom: row[0],
                        classe: parseInt(row[1]),
                        evaluation: row[2],
                        date: row[3],
                        qualite: {
                            vsc: parseInt(row[4]) || 0,
                            horsSujet: parseInt(row[5]) || 0,
                            faux: parseInt(row[6]) || 0,
                            incomplet: parseInt(row[7]) || 0
                        },
                        ensuite: {
                            analyse: parseInt(row[8]) || 0,
                            lecture: parseInt(row[9]) || 0,
                            redaction: parseInt(row[10]) || 0,
                            memoire: parseInt(row[11]) || 0
                        }
                    })).filter(data => data.nom); // Filter out empty rows
                } else {
                    // Fallback to localStorage
                    studentData = JSON.parse(localStorage.getItem('studentData') || '[]');
                }
            } catch (error) {
                console.error('Erreur chargement donn√©es √©l√®ves:', error);
                studentData = JSON.parse(localStorage.getItem('studentData') || '[]');
            }
        }

        // Couleurs de l'√©cole
        const schoolColors = {
            blue: 'rgba(7,45,110,1)',
            red: 'rgba(208,13,43,1)',
            white: 'rgba(255,255,255,1)',
            blueLight: 'rgba(7,45,110,0.7)',
            redLight: 'rgba(208,13,43,0.7)'
        };

        // Navigation
        function showHome() {
            hideAllPages();
            document.getElementById('home-page').classList.remove('hidden');
        }

        function showStudentLogin() {
            hideAllPages();
            document.getElementById('student-login').classList.remove('hidden');
        }

        function showTeacherLogin() {
            hideAllPages();
            document.getElementById('teacher-login').classList.remove('hidden');
        }

        function showStudentGraphs() {
            hideAllPages();
            document.getElementById('student-graphs').classList.remove('hidden');
        }

        function hideAllPages() {
            const pages = ['home-page', 'student-login', 'teacher-login', 'student-form', 'student-graphs', 'teacher-panel'];
            pages.forEach(page => {
                document.getElementById(page).classList.add('hidden');
            });
            document.getElementById('student-charts').classList.add('hidden');
        }

        // Authentification √©l√®ve
        function loginStudent() {
            const password = document.getElementById('student-password').value;
            const messageDiv = document.getElementById('student-login-message');
            
            const student = studentsData.find(s => s.motDePasse === password);
            
            if (student) {
                currentStudent = student;
                showStudentForm();
                messageDiv.innerHTML = '';
            } else {
                messageDiv.innerHTML = '<div class="message error">Mot de passe incorrect</div>';
            }
        }

        // Authentification enseignant
        function loginTeacher() {
            const password = document.getElementById('teacher-password').value;
            const messageDiv = document.getElementById('teacher-login-message');
            
            if (password === '2526') {
                showTeacherPanel();
                messageDiv.innerHTML = '';
            } else {
                messageDiv.innerHTML = '<div class="message error">Mot de passe incorrect</div>';
            }
        }

        // Afficher le formulaire √©l√®ve
        function showStudentForm() {
            hideAllPages();
            document.getElementById('student-form').classList.remove('hidden');
            
            // Remplir les informations de l'√©l√®ve
            document.getElementById('student-name').value = currentStudent.nom;
            document.getElementById('student-class').value = currentStudent.classe;
            
            // Charger les √©valuations disponibles
            loadEvaluations();
        }

        // Charger les √©valuations
        async function loadEvaluations() {
            const select = document.getElementById('evaluation-select');
            select.innerHTML = '<option value="">Chargement des √©valuations...</option>';
            
            // Charger depuis Google Sheets
            await loadEvaluationsFromSheet();
            
            select.innerHTML = '<option value="">S√©lectionner une √©valuation</option>';
            
            evaluations.forEach(eval => {
                const option = document.createElement('option');
                option.value = eval.name;
                option.textContent = `${eval.name} (${eval.type} - ${eval.questions} questions)`;
                option.dataset.type = eval.type;
                select.appendChild(option);
            });
        }

        // G√©rer le changement d'√©valuation
        document.addEventListener('DOMContentLoaded', function() {
            const evalSelect = document.getElementById('evaluation-select');
            if (evalSelect) {
                evalSelect.addEventListener('change', function() {
                    const selectedOption = this.options[this.selectedIndex];
                    const evalType = selectedOption.dataset.type;
                    
                    // Afficher/masquer la ligne "m√©moire" selon le type C1/C2
                    const memoireRow = document.getElementById('memoire-row');
                    if (memoireRow) {
                        if (evalType === 'C2') {
                            memoireRow.style.display = 'none';
                            document.getElementById('ensuite-memoire').value = '0';
                        } else {
                            memoireRow.style.display = 'block';
                        }
                    }
                });
            }
        });

        // Sauvegarder les donn√©es de l'√©l√®ve
        async function saveStudentData() {
            const messageDiv = document.getElementById('form-message');
            const evaluationName = document.getElementById('evaluation-select').value;
            
            if (!evaluationName) {
                messageDiv.innerHTML = '<div class="message warning">Il faut choisir une √©valuation</div>';
                return;
            }
            
            const data = {
                type: 'student_data',
                nom: currentStudent.nom,
                classe: currentStudent.classe,
                evaluation: evaluationName,
                date: new Date().toISOString(),
                qualite: {
                    vsc: parseInt(document.getElementById('qualite-vsc').value) || 0,
                    horsSujet: parseInt(document.getElementById('qualite-hors-sujet').value) || 0,
                    faux: parseInt(document.getElementById('qualite-faux').value) || 0,
                    incomplet: parseInt(document.getElementById('qualite-incomplet').value) || 0
                },
                ensuite: {
                    analyse: parseInt(document.getElementById('ensuite-analyse').value) || 0,
                    lecture: parseInt(document.getElementById('ensuite-lecture').value) || 0,
                    redaction: parseInt(document.getElementById('ensuite-redaction').value) || 0,
                    memoire: parseInt(document.getElementById('ensuite-memoire').value) || 0
                }
            };
            
            messageDiv.innerHTML = '<div class="message">Sauvegarde en cours...</div>';
            
            // Sauvegarder dans Google Sheets
            const success = await writeToSheet(data);
            
            if (success) {
                // R√©initialiser le formulaire
                resetForm();
                messageDiv.innerHTML = '<div class="message success">Tes donn√©es ont bien √©t√© enregistr√©es</div>';
            } else {
                messageDiv.innerHTML = '<div class="message error">Tes donn√©es n\'ont pas √©t√© bien enregistr√©es</div>';
            }
        }

        // R√©initialiser le formulaire
        function resetForm() {
            document.getElementById('evaluation-select').value = '';
            document.getElementById('qualite-vsc').value = '0';
            document.getElementById('qualite-hors-sujet').value = '0';
            document.getElementById('qualite-faux').value = '0';
            document.getElementById('qualite-incomplet').value = '0';
            document.getElementById('ensuite-analyse').value = '0';
            document.getElementById('ensuite-lecture').value = '0';
            document.getElementById('ensuite-redaction').value = '0';
            document.getElementById('ensuite-memoire').value = '0';
        }

        // Afficher les graphiques √©l√®ve
        async function showStudentGraphsData() {
            const password = document.getElementById('graphs-password').value;
            const messageDiv = document.getElementById('graphs-login-message');
            
            const student = studentsData.find(s => s.motDePasse === password);
            
            if (student) {
                currentStudent = student;
                messageDiv.innerHTML = '<div class="message">Chargement de vos graphiques...</div>';
                
                // Charger les donn√©es depuis Google Sheets
                await loadStudentDataFromSheet();
                
                document.getElementById('student-charts').classList.remove('hidden');
                document.getElementById('student-charts-title').textContent = `Graphiques de ${student.nom}`;
                generateStudentCharts(student);
                messageDiv.innerHTML = '';
            } else {
                messageDiv.innerHTML = '<div class="message error">Mot de passe incorrect</div>';
            }
        }

        // G√©n√©rer les graphiques pour un √©l√®ve
        function generateStudentCharts(student) {
            // Utiliser les donn√©es charg√©es depuis Google Sheets
            const studentDataFiltered = studentData.filter(d => d.nom === student.nom);
            
            // Graphiques par √©valuation
            const evaluationChartsDiv = document.getElementById('evaluation-charts');
            evaluationChartsDiv.innerHTML = '';
            
            if (studentDataFiltered.length === 0) {
                evaluationChartsDiv.innerHTML = '<p>Aucune donn√©e disponible pour cet √©l√®ve.</p>';
                return;
            }
            
            studentDataFiltered.forEach(evalData => {
                const evalDiv = document.createElement('div');
                evalDiv.innerHTML = `
                    <h3>${evalData.evaluation}</h3>
                    <div class="charts-container">
                        <div class="chart-card">
                            <h4>Qualit√© de tes r√©ponses</h4>
                            <canvas id="quality-${evalData.evaluation.replace(/\s+/g, '-')}"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>Que faire ensuite</h4>
                            <canvas id="next-${evalData.evaluation.replace(/\s+/g, '-')}"></canvas>
                        </div>
                    </div>
                `;
                evaluationChartsDiv.appendChild(evalDiv);
                
                // Cr√©er les graphiques
                createBarChart(`quality-${evalData.evaluation.replace(/\s+/g, '-')}`, 
                    ['VSC', 'Hors sujet', 'Faux', 'Incomplet'],
                    [evalData.qualite.vsc, evalData.qualite.horsSujet, evalData.qualite.faux, evalData.qualite.incomplet],
                    [schoolColors.blue, schoolColors.red, schoolColors.blueLight, schoolColors.redLight]
                );
                
                createBarChart(`next-${evalData.evaluation.replace(/\s+/g, '-')}`, 
                    ['Analyse question', 'Lecture strat√©gique', 'R√©daction', 'M√©moire'],
                    [evalData.ensuite.analyse, evalData.ensuite.lecture, evalData.ensuite.redaction, evalData.ensuite.memoire],
                    [schoolColors.blue, schoolColors.red, schoolColors.blueLight, schoolColors.redLight]
                );
            });
            
            // Graphiques de synth√®se
            if (studentDataFiltered.length > 0) {
                const qualiteTotals = studentDataFiltered.reduce((acc, d) => {
                    acc.vsc += d.qualite.vsc;
                    acc.horsSujet += d.qualite.horsSujet;
                    acc.faux += d.qualite.faux;
                    acc.incomplet += d.qualite.incomplet;
                    return acc;
                }, {vsc: 0, horsSujet: 0, faux: 0, incomplet: 0});
                
                const ensuiteTotals = studentDataFiltered.reduce((acc, d) => {
                    acc.analyse += d.ensuite.analyse;
                    acc.lecture += d.ensuite.lecture;
                    acc.redaction += d.ensuite.redaction;
                    acc.memoire += d.ensuite.memoire;
                    return acc;
                }, {analyse: 0, lecture: 0, redaction: 0, memoire: 0});
                
                createBarChart('summary-quality-chart',
                    ['VSC', 'Hors sujet', 'Faux', 'Incomplet'],
                    [qualiteTotals.vsc, qualiteTotals.horsSujet, qualiteTotals.faux, qualiteTotals.incomplet],
                    [schoolColors.blue, schoolColors.red, schoolColors.blueLight, schoolColors.redLight]
                );
                
                createBarChart('summary-next-chart',
                    ['Analyse question', 'Lecture strat√©gique', 'R√©daction', 'M√©moire'],
                    [ensuiteTotals.analyse, ensuiteTotals.lecture, ensuiteTotals.redaction, ensuiteTotals.memoire],
                    [schoolColors.blue, schoolColors.red, schoolColors.blueLight, schoolColors.redLight]
                );
            }
        }

        // Cr√©er un graphique en barres
        function createBarChart(canvasId, labels, data, colors) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            // D√©truire le graphique existant s'il y en a un
            if (Chart.getChart(ctx)) {
                Chart.getChart(ctx).destroy();
            }
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    },
                    plugins: {
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            formatter: function(value) {
                                return value;
                            }
                        }
                    }
                },
                plugins: [{
                    afterDatasetsDraw: function(chart) {
                        const ctx = chart.ctx;
                        chart.data.datasets.forEach((dataset, i) => {
                            const meta = chart.getDatasetMeta(i);
                            meta.data.forEach((bar, index) => {
                                const data = dataset.data[index];
                                if (data > 0) {
                                    ctx.fillStyle = '#000';
                                    ctx.font = '12px Arial';
                                    ctx.textAlign = 'center';
                                    ctx.fillText(data, bar.x, bar.y - 5);
                                }
                            });
                        });
                    }
                }]
            });
        }

        // Interface enseignant
        function showTeacherPanel() {
            hideAllPages();
            document.getElementById('teacher-panel').classList.remove('hidden');
            loadTeacherData();
        }

        function loadTeacherData() {
            // Charger la liste des √©tudiants
            const studentsListDiv = document.getElementById('students-list');
            studentsListDiv.innerHTML = '';
            
            studentsData.forEach(student => {
                const studentCard = document.createElement('div');
                studentCard.className = 'student-card';
                studentCard.innerHTML = `
                    <strong>${student.nom}</strong><br>
                    Classe ${student.classe}
                `;
                studentCard.onclick = () => showStudentDetails(student);
                studentsListDiv.appendChild(studentCard);
            });
        }

        async function createEvaluation() {
            const name = document.getElementById('new-eval-name').value;
            const type = document.getElementById('eval-type').value;
            const questions = parseInt(document.getElementById('question-count').value);
            
            if (!name) {
                alert('Veuillez entrer un nom pour l\'√©valuation');
                return;
            }
            
            const evaluation = {
                type: 'evaluation',
                name: name,
                type: type,
                questions: questions,
                date: new Date().toISOString()
            };
            
            // Sauvegarder dans Google Sheets
            const success = await writeToSheet(evaluation);
            
            if (success) {
                // R√©initialiser le formulaire
                document.getElementById('new-eval-name').value = '';
                document.getElementById('question-count').value = '15';
                
                // Recharger les √©valuations
                await loadEvaluationsFromSheet();
                
                alert('√âvaluation cr√©√©e avec succ√®s !');
            } else {
                alert('Erreur lors de la cr√©ation de l\'√©valuation');
            }
        }

        async function showClassData(classFilter) {
            // Charger les donn√©es depuis Google Sheets
            await loadStudentDataFromSheet();
            
            let filteredData = studentData;
            
            if (classFilter !== 'all') {
                filteredData = studentData.filter(d => d.classe.toString() === classFilter);
            }
            
            // Mettre √† jour les boutons actifs
            document.querySelectorAll('.class-selector .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // G√©n√©rer les graphiques pour la classe
            generateClassCharts(filteredData, classFilter);
        }

        function generateClassCharts(data, classFilter) {
            const chartsDiv = document.getElementById('teacher-charts');
            chartsDiv.innerHTML = `
                <h4>Donn√©es - ${classFilter === 'all' ? 'Tous les √©l√®ves' : 'Classe ' + classFilter}</h4>
                <div class="charts-container">
                    <div class="chart-card">
                        <h4>Qualit√© des r√©ponses - Synth√®se</h4>
                        <canvas id="teacher-quality-chart"></canvas>
                    </div>
                    <div class="chart-card">
                        <h4>Que faire ensuite - Synth√®se</h4>
                        <canvas id="teacher-next-chart"></canvas>
                    </div>
                </div>
            `;
            
            if (data.length === 0) {
                chartsDiv.innerHTML += '<p>Aucune donn√©e disponible pour cette s√©lection.</p>';
                return;
            }
            
            // Calculer les totaux
            const qualiteTotals = data.reduce((acc, d) => {
                acc.vsc += d.qualite.vsc;
                acc.horsSujet += d.qualite.horsSujet;
                acc.faux += d.qualite.faux;
                acc.incomplet += d.qualite.incomplet;
                return acc;
            }, {vsc: 0, horsSujet: 0, faux: 0, incomplet: 0});
            
            const ensuiteTotals = data.reduce((acc, d) => {
                acc.analyse += d.ensuite.analyse;
                acc.lecture += d.ensuite.lecture;
                acc.redaction += d.ensuite.redaction;
                acc.memoire += d.ensuite.memoire;
                return acc;
            }, {analyse: 0, lecture: 0, redaction: 0, memoire: 0});
            
            createBarChart('teacher-quality-chart',
                ['VSC', 'Hors sujet', 'Faux', 'Incomplet'],
                [qualiteTotals.vsc, qualiteTotals.horsSujet, qualiteTotals.faux, qualiteTotals.incomplet],
                [schoolColors.blue, schoolColors.red, schoolColors.blueLight, schoolColors.redLight]
            );
            
            createBarChart('teacher-next-chart',
                ['Analyse question', 'Lecture strat√©gique', 'R√©daction', 'M√©moire'],
                [ensuiteTotals.analyse, ensuiteTotals.lecture, ensuiteTotals.redaction, ensuiteTotals.memoire],
                [schoolColors.blue, schoolColors.red, schoolColors.blueLight, schoolColors.redLight]
            );
        }

        async function showStudentDetails(student) {
            // Charger les donn√©es depuis Google Sheets
            await loadStudentDataFromSheet();
            
            const studentDataFiltered = studentData.filter(d => d.nom === student.nom);
            
            if (studentDataFiltered.length === 0) {
                alert(`Aucune donn√©e disponible pour ${student.nom}`);
                return;
            }
            
            // Cr√©er une fen√™tre modale ou une nouvelle section pour afficher les d√©tails
            const detailsWindow = window.open('', '_blank', 'width=800,height=600');
            let html = `
                <html>
                <head>
                    <title>D√©tails - ${student.nom}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .evaluation { margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
                        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
                        .section { background: #f8f9fa; padding: 15px; border-radius: 8px; }
                        .section h4 { color: rgba(7,45,110,1); margin-bottom: 10px; }
                        .item { display: flex; justify-content: space-between; margin-bottom: 5px; }
                    </style>
                </head>
                <body>
                    <h1>D√©tails pour ${student.nom} - Classe ${student.classe}</h1>
            `;
            
            studentDataFiltered.forEach(evalData => {
                html += `
                    <div class="evaluation">
                        <h3>${evalData.evaluation}</h3>
                        <small>Date: ${new Date(evalData.date).toLocaleDateString()}</small>
                        <div class="grid">
                            <div class="section">
                                <h4>Qualit√© de tes r√©ponses</h4>
                                <div class="item"><span>VSC:</span> <span>${evalData.qualite.vsc}</span></div>
                                <div class="item"><span>Hors sujet:</span> <span>${evalData.qualite.horsSujet}</span></div>
                                <div class="item"><span>Faux:</span> <span>${evalData.qualite.faux}</span></div>
                                <div class="item"><span>Incomplet:</span> <span>${evalData.qualite.incomplet}</span></div>
                            </div>
                            <div class="section">
                                <h4>Que faire ensuite</h4>
                                <div class="item"><span>Analyse question:</span> <span>${evalData.ensuite.analyse}</span></div>
                                <div class="item"><span>Lecture strat√©gique:</span> <span>${evalData.ensuite.lecture}</span></div>
                                <div class="item"><span>R√©daction:</span> <span>${evalData.ensuite.redaction}</span></div>
                                <div class="item"><span>M√©moire:</span> <span>${evalData.ensuite.memoire}</span></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</body></html>';
            detailsWindow.document.write(html);
        }

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            showHome();
        });
    </script>
</body>
</html>
